{% extends "base.html" %}

{% block title %}Swimmer Lessons{% endblock %}

{% block content %}
<link
  rel="stylesheet"
  href="{{ url_for('static', filename='swimmer_lesson.css') }}"
/>

<div class="lesson-container">
    <!-- Flash Messages -->
    {% with messages = get_flashed_messages(with_categories=true) %}
      {% if messages %}
        {% for category, message in messages %}
          <div class="flash-message alert-{{ category }}">
            <span class="message-text">{{ message }}</span>
            <span class="close-btn" onclick="this.parentElement.style.display='none';">&times;</span>
          </div>
        {% endfor %}
      {% endif %}
    {% endwith %}

    <!-- Welcome Section -->
    <div class="welcome-section">
        <h1 class="title">Welcome, Swimmer {{ forename }}!</h1>
        <div class="navigation-links">
            <a href="{{ url_for('swimmer_homepage') }}" class="btn-secondary">Back to Homepage</a>
        </div>
    </div>

    <!-- Filter Form -->
    <div class="filter-form">
        <h2 class="section-title">Filter Lessons</h2>
        <form method="GET" action="{{ url_for('swimmer_lessons') }}">
            <div class="form-group">
                <label for="class_date">Class Date</label>
                <input type="date" class="form-control" id="class_date" name="class_date" value="{{ filters.get('class_date', '') }}">
            </div>
            <div class="form-group">
                <label for="start_time">Start Time After</label>
                <input type="time" class="form-control" id="start_time" name="start_time" value="{{ filters.get('start_time', '') }}">
            </div>
            <div class="form-group">
                <label for="end_time">End Time Before</label>
                <input type="time" class="form-control" id="end_time" name="end_time" value="{{ filters.get('end_time', '') }}">
            </div>
            <div class="form-group">
                <label for="pool_id">Pool</label>
                <select class="form-control" id="pool_id" name="pool_id">
                    <option value="All" {% if filters.get('pool_id') == 'All' or not filters.get('pool_id') %}selected{% endif %}>All Pools</option>
                    {% for pool in pools %}
                    <option value="{{ pool.pool_id }}" {% if filters.get('pool_id') == pool.pool_id|string %}selected{% endif %}>
                        {{ pool.location }}
                    </option>
                    {% endfor %}
                </select>
            </div>
            <div class="form-actions">
                <button type="submit" class="btn-primary">Apply Filters</button>
                <a href="{{ url_for('swimmer_lessons') }}" class="btn-secondary">Reset Filters</a>
            </div>
        </form>
    </div>

    <!-- Lessons Table -->
    <div class="lessons-section">
        <h2 class="section-title">Available Lessons</h2>
        {% if lessons %}
        <table class="table">
            <thead>
                <tr>
                    <th>Session ID</th>
                    <th>Description</th>
                    <th>Date</th>
                    <th>Start Time</th>
                    <th>End Time</th>
                    <th>Pool</th>
                    <th>Class Type</th>
                    <th>Capacity</th>
                    <th>Enrolled Students</th>
                    <th>Price</th>
                    <th>Coach</th>
                    <th>Action</th>
                </tr>
            </thead>
            <tbody>
                {% for lesson in lessons %}
                <tr>
                    <td>{{ lesson.session_id }}</td>
                    <td>{{ lesson.description }}</td>
                    <td>{{ lesson.date.strftime('%Y-%m-%d') }}</td>
                    <td>{{ lesson.start_time }}</td>
                    <td>{{ lesson.end_time }}</td>
                    <td>{{ lesson.pool_location }}</td>
                    <td>{{ lesson.session_type }}</td>
                    <td>{{ lesson.capacity }}</td>
                    <td>{{ lesson.student_count }}</td>
                    <td>${{ "%.2f"|format(lesson.price) }}</td>
                    <td>{{ lesson.coach_forename }} {{ lesson.coach_surname }}</td>
                    <td>
                        {% if lesson.is_enrolled %}
                        <form action="{{ url_for('exit_lesson', session_id=lesson.session_id) }}" method="post">
                            <button type="submit" class="btn-danger btn-sm">Exit</button>
                        </form>
                        {% elif lesson.is_in_queue %}
                        <form action="{{ url_for('quit_queue', session_id=lesson.session_id) }}" method="post" style="display:inline;">
                            <button type="submit" class="btn-secondary btn-sm">Quit Queue</button>
                        </form>
                        {% elif lesson.can_join_queue %}
                        <form action="{{ url_for('join_queue', session_id=lesson.session_id) }}" method="post" style="display:inline;">
                            <button type="submit" class="btn-warning btn-sm">Join Queue</button>
                        </form>
                        {% else %}
                        {% if lesson.student_count < lesson.capacity %}
                        <form action="{{ url_for('enroll_lesson', session_id=lesson.session_id) }}" method="post" style="display:inline;">
                            <button type="submit" class="btn-primary btn-sm">Enroll</button>
                        </form>
                        {% else %}
                        <button type="button" class="btn-secondary btn-sm" disabled>Course is Full</button>
                        {% endif %}
                        {% endif %}
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        {% else %}
        <p>No lessons found matching your criteria.</p>
        {% endif %}
    </div>
</div>
{% endblock %}
